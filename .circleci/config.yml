version: 2.1

filter_all: &filter_all
  filters:
    branches:
      only: /.*/
    tags:
      only: /.*/

filter_demo: &filter_demo
  filters:
    branches:
      only: main
    tags:
      only: demo

filter_prod: &filter_prod
  filters:
    branches:
      ignore: /.*/
    tags:
      only: /^v[0-9]+\.[0-9]+\.[0-9]+/

workflows:
  test-and-deploy:
    jobs:
      - test:
          <<: *filter_all
      - deploy:
          name: Deploy (demo)
          context: "AWS Deploy"
          <<: *filter_demo
          tag: demo
          requires:
            - test
      - deploy:
          name: Deploy (prod)
          context: "AWS Deploy"
          env: prod
          <<: *filter_prod
          requires:
            - test

jobs: 
  test:
    executor: default
    steps:
      - checkout
      - run:
          name: placeholder
          command: |
            npm ci
            npm run test        

  deploy:
    docker: 
      - image: circleci/python:3.6
    parameters:
      env:
        type: enum
        default: "demo"
        enum: ["demo", "prod"]
      tag:
        type: string
        default: ""
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13            
      - run:
          name: Deploy
          environment:
            ENV: <<parameters.env>>
            TAG: <<parameters.tag>>
            ROLE: radiolab-vue-<<parameters.env>>
          command: |
            TAG=${TAG:-$CIRCLE_TAG}

            python3 -m venv ~/.venv
            source ~/.venv/bin/activate
            pip3 install -U git+https://github.com/nypublicradio/nyprsetuptools.git
            
            nyprsetuptools DockerDeploy \
              --fargate \
              --cpu=256 \
              --memory-reservation=512 \
              --ecr-repository=radiolab-vue \
              --ecs-cluster=radiolab-vue \
              --ports=3000 \
              --execution-role=$ROLE \
              --task-role=$ROLE \
              --environment=$ENV \
              --tag=$TAG \
              --wait=300 

executors:
  default:
    docker:
      - image: cimg/node:14.18
    environment: 
      JOBS: 2